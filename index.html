<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Canvas Heart Animation</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #000;
        }
        canvas {
            position: absolute;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <canvas id="pinkboard"></canvas>
    <script>
        var settings = {
            particles: {
                length: 500,  // 最大粒子數量
                duration: 2,  // 粒子生命週期（秒）
                velocity: 100, // 粒子速度（像素/秒）
                effect: -0.75, // 粒子運動效果
                size: 30, // 粒子大小（像素）
            }
        };

        // Polyfill for requestAnimationFrame
        (function() {
            var vendors = ['ms', 'moz', 'webkit', 'o'];
            for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
                window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
                window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame'] || window[vendors[x] + 'CancelRequestAnimationFrame'];
            }
        })();

        // 點的處理
        var Point = (function() {
            function Point(x, y) {
                this.x = x || 0;
                this.y = y || 0;
            }

            Point.prototype.length = function() {
                return Math.sqrt(this.x * this.x + this.y * this.y);
            };

            Point.prototype.clone = function(length) {
                if (typeof length === 'undefined') {
                    return new Point(this.x, this.y);
                }
                this.normalize();
                this.x *= length;
                this.y *= length;
                return this;
            };

            Point.prototype.normalize = function() {
                var len = this.length();
                this.x /= len;
                this.y /= len;
                return this;
            };

            return Point;
        })();

        // 粒子
        var Particle = (function() {
            function Particle(x, y, dx, dy) {
                this.position = new Point(x, y);
                this.velocity = new Point(dx, dy);
                this.acceleration = new Point(dx * settings.particles.effect, dy * settings.particles.effect);
                this.age = 0;
            }

            Particle.prototype.update = function(deltaTime) {
                this.position.x += this.velocity.x * deltaTime;
                this.position.y += this.velocity.y * deltaTime;
                this.velocity.x += this.acceleration.x * deltaTime;
                this.velocity.y += this.acceleration.y * deltaTime;
                this.age += deltaTime;
            };

            Particle.prototype.draw = function(context, image) {
                var size = image.width * ease(this.age / settings.particles.duration);
                context.globalAlpha = 1 - this.age / settings.particles.duration;
                context.drawImage(image, this.position.x - size / 2, this.position.y - size / 2, size, size);
            };

            function ease(t) {
                return (--t) * t * t + 1;
            }

            return Particle;
        })();

        // 粒子池
        var ParticlePool = (function() {
            var particles, firstActive = 0, firstFree = 0, duration = settings.particles.duration;

            function ParticlePool(length) {
                particles = new Array(length);
                for (var i = 0; i < length; i++) {
                    particles[i] = new Particle(0, 0, 0, 0);
                }
            }

            ParticlePool.prototype.getFreeParticle = function() {
                if (firstFree >= settings.particles.length) {
                    return null;
                }
                return particles[firstFree++];
            };

            ParticlePool.prototype.update = function(deltaTime) {
                for (var i = firstActive; i < firstFree; i++) {
                    var particle = particles[i];
                    particle.update(deltaTime);
                    if (particle.age > settings.particles.duration) {
                        particles[i] = particles[--firstFree];
                    }
                }
            };

            return ParticlePool;
        })();

        // 用於生成心形的點
        function pointOnHeart(t) {
            return new Point(
                160 * Math.pow(Math.sin(t), 3),
                130 * Math.cos(t) - 50 * Math.cos(2 * t) - 20 * Math.cos(3 * t) - 10 * Math.cos(4 * t)
            );
        }

        // 創建心形圖像
        var createHeartImage = (function() {
            var canvas = document.createElement('canvas');
            var context = canvas.getContext('2d');
            canvas.width = settings.particles.size;
            canvas.height = settings.particles.size;

            function to(t) {
                var point = pointOnHeart(t);
                return new Point(
                    canvas.width / 2 + point.x * settings.particles.size / 320,
                    canvas.height / 2 - point.y * settings.particles.size / 320
                );
            }

            context.beginPath();
            for (var t = -Math.PI; t < Math.PI; t += 0.01) {
                var point = to(t);
                context.lineTo(point.x, point.y);
            }
            context.closePath();
            context.fillStyle = '#ea80b0';
            context.fill();

            var image = new Image();
            image.src = canvas.toDataURL();
            return image;
        })();

        // 主要動畫循環
        (function(canvas) {
            var context = canvas.getContext('2d');
            var particlePool = new ParticlePool(settings.particles.length);
            var particleRate = settings.particles.length / settings.particles.duration;
            var lastTime = Date.now();

            // 設置canvas大小
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            // 動畫循環
            function animate() {
                var now = Date.now();
                var deltaTime = (now - lastTime) / 1000;
                lastTime = now;

                // 清除畫布
                context.clearRect(0, 0, canvas.width, canvas.height);

                // 更新粒子
                particlePool.update(deltaTime);

                // 創建新粒子
                for (var i = 0; i < particleRate * deltaTime; i++) {
                    var angle = Math.random() * Math.PI * 2;
                    var speed = Math.random() * settings.particles.velocity;
                    var x = canvas.width / 2 + Math.cos(angle) * 100;
                    var y = canvas.height / 2 + Math.sin(angle) * 100;
                    var dx = Math.cos(angle) * speed;
                    var dy = Math.sin(angle) * speed;

                    var particle = particlePool.getFreeParticle();
                    if (particle) {
                        particle.position.x = x;
                        particle.position.y = y;
                        particle.velocity.x = dx;
                        particle.velocity.y = dy;
                        particle.acceleration.x = dx * settings.particles.effect;
                        particle.acceleration.y = dy * settings.particles.effect;
                    }
                }

                // 繪製粒子
                for (var i = 0; i < particlePool.particles.length; i++) {
                    var particle = particlePool.particles[i];
                    if (particle.age < settings.particles.duration) {
                        particle.draw(context, createHeartImage);
                    }
                }

                requestAnimationFrame(animate);
            }

            animate();
        })(document.getElementById('pinkboard'));
    </script>
</body>
</html>
